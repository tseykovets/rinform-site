/*

Gnusto
======

Built: 2013-07-29

Copyright (c) 2003-2013 The Gnusto Contributors
GNU GPL licenced
https://github.com/curiousdannii/gnusto

String.prototype.quote() taken from "Remedial Javascript" by Douglas Crockford: http://javascript.crockford.com/remedial.html

*/
function handleZ_je(t,e){if(2>e.length)return"";if(2==e.length)return t._brancher(e[0]+"=="+e[1]);for(var r="",n=1;e.length>n;n++)1!=n&&(r+="||"),r=r+"t=="+e[n];return"t="+e[0]+";"+t._brancher(r)}function handleZ_jl(t,e){var r,n;return r=isNotConst.test(e[0])?"t="+e[0]+";t=((t & 0x8000 ? ~0xFFFF : 0) | t);":"t="+t._unsigned2signed(e[0])+";",n=isNotConst.test(e[1])?"t2="+e[1]+";t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);":"t2="+t._unsigned2signed(e[1])+";",r+n+t._brancher("t<t2")}function handleZ_jg(t,e){var r,n;return r=isNotConst.test(e[0])?"t="+e[0]+";t=((t & 0x8000 ? ~0xFFFF : 0) | t);":"t="+t._unsigned2signed(e[0])+";",n=isNotConst.test(e[1])?"t2="+e[1]+";t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);":"t2="+t._unsigned2signed(e[1])+";",r+n+t._brancher("t>t2")}function handleZ_inc_chk(t,e){var r=handleZ_inc(t,e);return r+="{var t1=incdec; t1 = ((t1 & 0x8000 ? ~0xFFFF : 0) | t1); var t2="+e[1]+"; t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);"+t._brancher("t1 > t2")+"}"}function handleZ_dec_chk(t,e){var r=handleZ_dec(t,e);return r+="{var t1=incdec; t1 = ((t1 & 0x8000 ? ~0xFFFF : 0) | t1); var t2="+e[1]+"; t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);"+t._brancher("t1 < t2")+"}"}function handleZ_jin(t,e){return t._brancher("_obj_in("+e[0]+","+e[1]+")")}function handleZ_test(t,e){return"t="+e[1]+";"+t._brancher("("+e[0]+"&t)==t")}function handleZ_or(t,e){return t._storer("("+e[0]+"|"+e[1]+")")}function handleZ_and(t,e){return t._storer("("+e[0]+"&"+e[1]+")")}function handleZ_test_attr(t,e){return t._brancher("_test_attr("+e[0]+","+e[1]+")")}function handleZ_set_attr(t,e){return"_set_attr("+e[0]+","+e[1]+")"}function handleZ_clear_attr(t,e){return"_clear_attr("+e[0]+","+e[1]+")"}function handleZ_store(t,e){var r;return r=isNaN(e[0])?"("+e[0]+" == 0) ? m_gamestack[m_gamestack.length - 1] = "+e[1]+" : ("+e[0]+" < 0x10) ? m_locals[( "+e[0]+" - 1 )] = "+e[1]+" : setWord("+e[1]+", m_vars_start + ( "+e[0]+" - 16 ) * 2 )":0==e[0]?"m_gamestack[m_gamestack.length - 1] = "+e[1]:16>e[0]?"m_locals[( "+e[0]+" - 1 )] = "+e[1]:"setWord("+e[1]+", m_vars_start + ( "+e[0]+" - 16 ) * 2 )"}function handleZ_insert_obj(t,e){return"_insert_obj("+e[0]+","+e[1]+")"}function handleZ_loadw(t,e){if(isNotConst.test(e[0])||isNotConst.test(e[1]))var r="var tmp_"+ ++temp_var+" = ("+e[0]+" + 2 * "+e[1]+") & 0xFFFF, ",n="tmp_"+temp_var,s=n+"+1";else var r="var ",n=65535&e[0]+2*e[1],s=n+1;var i="tmp_"+ ++temp_var;return r+i+" = (m_memory["+n+"] << 8) | m_memory["+s+"];"+t._storer(i)}function handleZ_loadb(t,e){return t._storer("m_memory[0xFFFF&("+e[0]+"+"+e[1]+")]")}function handleZ_get_prop(t,e){return t._storer("_get_prop("+e[0]+","+e[1]+")")}function handleZ_get_prop_addr(t,e){return t._storer("_get_prop_addr("+e[0]+","+e[1]+")")}function handleZ_get_next_prop(t,e){return t._storer("_get_next_prop("+e[0]+","+e[1]+")")}function handleZ_add(t,e){return t._storer("("+e[0]+" + "+e[1]+") & 0xFFFF")}function handleZ_sub(t,e){return t._storer("("+e[0]+" - "+e[1]+") & 0xFFFF")}function handleZ_mul(t,e){return t._storer("("+e[0]+"*"+e[1]+") & 0xFFFF")}function handleZ_div(t,e){return t._storer("_trunc_divide("+e[0]+","+e[1]+")")}function handleZ_mod(t,e){return t._storer("_trunc_modulo("+e[0]+","+e[1]+")")}function handleZ_set_colour(t,e){return"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_STYLE+",-1,"+e[0]+","+e[1]+"];return"}function handleZ_throw(t,e){return t.m_compilation_running=0,"_throw_stack_frame("+e[0]+");return"}function handleZ_jz(t,e){return t._brancher(e[0]+"==0")}function handleZ_get_sibling(t,e){return"t=_get_sibling("+e[0]+");"+t._storer("t")+";"+t._brancher("t")}function handleZ_get_child(t,e){return"t=_get_child("+e[0]+");"+t._storer("t")+";"+t._brancher("t")}function handleZ_get_parent(t,e){return t._storer("_get_parent("+e[0]+")")}function handleZ_get_prop_len(t,e){return t._storer("_get_prop_len("+e[0]+")")}function handleZ_inc(t,e){var r="var incdec; ";return r+=isNaN(e[0])?"var incdec; if ("+e[0]+" == 0) { incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] + 1) & 0xFFFF; } else if ("+e[0]+" < 0x10) { incdec = m_locals[( "+e[0]+" - 1 )] = (m_locals[( "+e[0]+" - 1 )] + 1) & 0xFFFF; } else { var val = getUnsignedWord(m_vars_start + ( "+e[0]+" - 16 ) * 2 ); val++; setWord(val, m_vars_start + ( "+e[0]+" - 16 ) * 2 ); incdec = val; }":0==e[0]?"incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] + 1) & 0xFFFF;":16>e[0]?"incdec = m_locals[( "+e[0]+" - 1 )] = (m_locals[( "+e[0]+" - 1 )] + 1) & 0xFFFF;":"{var val = getWord(m_vars_start + ( "+e[0]+" - 16 ) * 2 ); val++; setWord(val, m_vars_start + ( "+e[0]+" - 16 ) * 2 ); incdec = val;}"}function handleZ_dec(t,e){var r="var incdec; ";return r+=isNaN(e[0])?"if ("+e[0]+" == 0) { incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] - 1) & 0xFFFF; } else if ("+e[0]+" < 0x10) { incdec = m_locals[( "+e[0]+" - 1 )] = (m_locals[( "+e[0]+" - 1 )] - 1) & 0xFFFF; } else { var val = getUnsignedWord(m_vars_start + ( "+e[0]+" - 16 ) * 2 ); val--; setWord(val, m_vars_start + ( "+e[0]+" - 16 ) * 2 ); incdec = val; }":0==e[0]?"incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] - 1) & 0xFFFF;":16>e[0]?"incdec = m_locals[( "+e[0]+" - 1 )] = (m_locals[( "+e[0]+" - 1 )] - 1) & 0xFFFF;":"{var val = getUnsignedWord(m_vars_start + ( "+e[0]+" - 16 ) * 2 ); val--; setWord(val, m_vars_start + ( "+e[0]+" - 16 ) * 2 ); incdec = val;}"}function handleZ_print_addr(t,e){return t._handler_zOut("_zscii_from("+e[0]+")",0)}function handleZ_remove_obj(t,e){return"_remove_obj("+e[0]+","+e[1]+")"}function handleZ_print_obj(t,e){return t._handler_zOut("_name_of_object("+e[0]+")",0)}function handleZ_ret(t,e){return t.m_compilation_running=0,"_func_return("+e[0]+");return"}function handleZ_jump(t,e){t.m_compilation_running=0,32768&e[0]&&(e[0]=-65536|e[0]);var r=e[0]+t.m_pc-2;return"m_pc="+r+";return"}function handleZ_print_paddr(t,e){return t._handler_zOut("_zscii_from("+t.m_pc_translate_for_string(e[0])+")",0)}function handleZ_load(t,e){var r;return r=isNaN(e[0])?"("+e[0]+" == 0) ? m_gamestack[m_gamestack.length - 1] : ("+e[0]+" < 0x10) ? m_locals[( "+e[0]+" - 1 )] : getUnsignedWord( m_vars_start + ( "+e[0]+" - 16 ) * 2 )":0==e[0]?"m_gamestack[m_gamestack.length - 1]":16>e[0]?"m_locals[( "+e[0]+" - 1 )]":"getUnsignedWord( m_vars_start + ( "+e[0]+" - 16 ) * 2 )",t._storer(r)}function handleZ_rtrue(t){return t.m_compilation_running=0,"_func_return(1);return"}function handleZ_rfalse(t){return t.m_compilation_running=0,"_func_return(0);return"}function handleZ_print(t){return t._handler_print("",0)}function handleZ_print_ret(t){return t.m_compilation_running=0,t._handler_print("\n",1)+";_func_return(1);return"}function handleZ_nop(){return""}function handleZ_restart(t){return t.m_compilation_running=0,"m_effects=["+GNUSTO_EFFECT_RESTART+"];return"}function handleZ_ret_popped(t){return t.m_compilation_running=0,"_func_return(m_gamestack.pop());return"}function handleZ_catch(t){return t._storer("m_call_stack.length")}function handleZ_pop(){return"m_gamestack.pop()"}function handleZ_quit(t){return t.m_compilation_running=0,"m_effects=["+GNUSTO_EFFECT_QUIT+"];return"}function handleZ_new_line(t){return t._handler_zOut("'\\n'",0)}function handleZ_show_status(t){return t._handler_zOut(""),""}function handleZ_verify(t){return t._brancher("_verify()")}function handleZ_illegal_extended(){gnusto_error(199)}function handleZ_piracy(t){t.m_compilation_running=0;var e="m_rebound=function(){"+t._brancher("(!0)")+"};";return"m_pc="+t.m_pc+";"+e+"m_effects=["+GNUSTO_EFFECT_PIRACY+"];return"}function handleZ_call_1n(t,e){return t._generate_gosub(e[0],"",0)}function handleZ_call_1s(t,e){return t._generate_gosub(e[0],"",1)}function handleZ_call_2n(t,e){return t._generate_gosub(e[0],e[1],0)}function handleZ_call_2s(t,e){return t._generate_gosub(e[0],e[1],1)}function handleZ_call_vn(t,e){return t._generate_gosub(e[0],e.slice(1),0)}function handleZ_call_vs(t,e){return t._generate_gosub(e[0],e.slice(1),1)}function handleZ_store_w(t,e){if(isNotConst.test(e[0])||isNotConst.test(e[1]))var r="var tmp_"+ ++temp_var+" = ("+e[0]+" + 2 * "+e[1]+") & 0xFFFF;",n="tmp_"+temp_var,s=n+"+1";else var r="",n=65535&e[0]+2*e[1],s=n+1;if(isNotConst.test(e[2])){var i="tmp_"+ ++temp_var;return r+"var "+i+" = "+e[2]+";"+"m_memory["+n+"] = ("+i+" >> 8) & 0xFF;"+"m_memory["+s+"] = "+i+" & 0xFF;"}return t.m_value_asserts&&(null==e[2]||e[2]===!0||e[2]===!1||0>e[2]||e[2]>65535)&&t.logger("Z_store_w value",e[2]),r+"m_memory["+n+"] = "+(255&e[2]>>8)+";"+"m_memory["+s+"] = "+(255&e[2])}function handleZ_storeb(t,e){return"setByte("+e[2]+",("+e[0]+"+"+e[1]+")&0xFFFF)"}function handleZ_putprop(t,e){return"_put_prop("+e[0]+","+e[1]+","+e[2]+")"}function handleZ_read(t,e){var r,n;t.m_compilation_running=0;var s,i,_="_aread(m_answers[0],m_rebound_args[1],m_rebound_args[2],m_answers[1])";t.m_version>=5&&(_=t._storer(_)),t.m_version>=5?(s="m_memory[0xFFFF&a0+1]",i="m_memory[0xFFFF&a0]"):(s="0",i="m_memory[0xFFFF&a0]+1"),e[2]&&e[3]&&t.m_version>=4?(r=e[2],n=t.m_pc_translate_for_routine(e[3])):(r="0",n="0");var a="m_rebound=function(){var t=1*m_answers[0];if(t<0){_func_interrupt(m_rebound_args[0],onISRReturn_for_read);}else{"+_+";"+"}"+"};",o="m_rebound_args=["+n+","+"a0,"+e[1]+","+"];";return"var a0=eval("+e[0]+");"+"m_pc="+t.m_pc+";"+o+a+"m_effects=["+GNUSTO_EFFECT_INPUT+","+r+","+s+","+i+","+"_terminating_characters()];return"}function handleZ_print_char(t,e){return t._handler_zOut("_zscii_char_to_ascii("+e[0]+")",0)}function handleZ_print_num(t,e){return t._handler_zOut('""+_unsigned2signed('+e[0]+")",0)}function handleZ_random(t,e){return t._storer("_random_number("+e[0]+")")}function handleZ_push(t,e){return"m_gamestack.push("+e[0]+")"}function handleZ_pull(t,e){var r="var pull = m_gamestack.pop(); ";return r+=handleZ_store(t,[e[0],"pull"])}function handleZ_split_window(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SPLITWINDOW+","+e[0]+"];return"}function handleZ_set_window(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SETWINDOW+","+e[0]+"];return"}function handleZ_erase_window(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_ERASEWINDOW+","+t._unsigned2signed(e[0])+"];return"}function handleZ_erase_line(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_ERASELINE+","+e[0]+"];return"}function handleZ_set_cursor(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SETCURSOR+","+e[0]+","+e[1]+"];return"}function handleZ_get_cursor(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_GETCURSOR+","+e[0]+"];return"}function handleZ_set_text_style(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_STYLE+","+e[0]+",0,0];return"}function handleZ_buffer_mode(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SETBUFFERMODE+","+e[0]+"];return"}function handleZ_output_stream(t,e){return"_set_output_stream("+e[0]+","+e[1]+")"}function handleZ_input_stream(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SETINPUTSTREAM+","+e[0]+"];return"}function handleZ_sound_effect(t,e){for(t.m_compilation_running=0;5>e.length;)e.push(0);return"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SOUND+","+e[0]+","+e[1]+","+e[2]+","+e[3]+","+e[4]+"];return"}function handleZ_read_char(t,e){var r,n,s;return t.m_compilation_running=0,e[1]&&e[2]&&t.m_version>=4?(r=e[1],n="m_rebound_args=["+t.m_pc_translate_for_routine(e[2])+"];",s="m_rebound=function(){var t=m_answers[0];if(t<0){_func_interrupt(m_rebound_args[0],onISRReturn_for_read_char);}else{"+t._storer("_ascii_code_to_zscii_code(t)")+"}"+"};"):(r="0",n="",s="m_rebound=function(){"+t._storer("_ascii_code_to_zscii_code(m_answers[0])")+"};"),"m_pc="+t.m_pc+";"+n+s+"m_effects=["+GNUSTO_EFFECT_INPUT_CHAR+","+r+"];return"}function handleZ_scan_table(t,e){return 4==e.length?"t=_scan_table("+e[0]+","+e[1]+"&0xFFFF,"+e[2]+"&0xFFFF,"+e[3]+");"+t._storer("t")+";"+t._brancher("t"):"t=_scan_table("+e[0]+","+e[1]+"&0xFFFF,"+e[2]+"&0xFFFF,"+130+");"+t._storer("t")+";"+t._brancher("t")}function handleZ_not(t,e){return t._storer("~"+e[0]+"&0xffff")}function handleZ_tokenise(t,e){return"_tokenise("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"}function handleZ_encode_text(t,e){return"_encode_text("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"}function handleZ_copy_table(t,e){return"_copy_table("+e[0]+","+e[1]+","+e[2]+")"}function handleZ_print_table(t,e){return 3>e.length&&e.push(1),4>e.length&&e.push(0),"m_pc="+t.m_pc+";m_effects=_print_table("+e[0]+","+e[1]+","+e[2]+","+e[3]+");return"}function handleZ_check_arg_count(t,e){return t._brancher(e[0]+"<=_param_count()")}function handleZ_saveV123(t){t.m_compilation_running=0;var e="m_rebound=function(){"+t._brancher("m_answers[0]")+"};";return"m_state_to_save=_saveable_state(1);m_pc="+t.m_pc+";"+e+";m_effects=["+GNUSTO_EFFECT_SAVE+"];return"}function handleZ_saveV45678(t){t.m_compilation_running=0;var e="m_rebound=function() { "+t._storer("m_answers[0]")+"};";return"m_state_to_save=_saveable_state("+(4==t.m_version?"1":"3")+");m_pc="+t.m_pc+";"+e+";m_effects=["+GNUSTO_EFFECT_SAVE+"];return"}function handleZ_restoreV123(t){return t.m_compilation_running=0,t._brancher(""),"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_RESTORE+"];return"}function handleZ_restoreV45678(t){t.m_compilation_running=0;var e="m_rebound=function() { var t=m_answers[0]; if (t==0){"+t._storer("t")+"}};";return"m_pc="+t.m_pc+";"+e+"m_effects=["+GNUSTO_EFFECT_RESTORE+"];return"}function handleZ_log_shift(t,e){return t._storer("_log_shift("+e[0]+","+e[1]+")")}function handleZ_art_shift(t,e){return t._storer("_art_shift("+e[0]+","+e[1]+")")}function handleZ_set_font(t,e){return t._storer("("+e[0]+"<2?1:0)")}function handleZ_save_undo(t){return t._storer("_save_undo("+t.m_pc+")")}function handleZ_restore_undo(t){return"if(_restore_undo())return;"+t._storer("0")}function handleZ_print_unicode(t,e){return t._handler_zOut("String.fromCharCode("+e[0]+")",0)}function handleZ_check_unicode(t){return t._storer("3")}function handleZ_gestalt(t,e){return t._storer("gestalt("+e[0]+", "+(2>e.length?0:e[1])+")")}function handleZ_parchment(t,e){return t._storer("op_parchment("+e[0]+", "+(2>e.length?0:e[1])+")")}function pc_translate_v123(t){return"(("+t+")&0xFFFF)*2"}function pc_translate_v45(t){return"(("+t+")&0xFFFF)*4"}function pc_translate_v67R(t){return"(("+t+")&0xFFFF)*4+"+this.m_routine_start}function pc_translate_v67S(t){return"(("+t+")&0xFFFF)*4+"+this.m_string_start}function pc_translate_v8(t){return"(("+t+")&0xFFFF)*8"}function gnusto_error(t){message="Component: engine\n",message+="Code: "+t+"\n";for(var e=1;arguments.length>e;e++)arguments[e]&&arguments[e].toString&&(message+="\nDetail: "+(""+arguments[e]));throw new FatalError(message)}function onISRReturn_for_read_char(t,e){e?(t.engine.m_answers[0]=0,t.rebound()):(t.engine.m_effects=t.effects,t.engine.m_rebound=t.rebound,t.engine.m_rebound_args=t.rebound_args)}function onISRReturn_for_read(t,e){var r=t.engine;e?(r.m_answers[0]=0,r.m_answers[1]="",t.rebound()):(r.m_effects=t.effects,r.m_rebound=t.rebound,r.m_rebound_args=t.rebound_args)}function GnustoEngine(t){this.logger=t?function(e,r){t("gnusto-engine: "+e+": "+r)}:function(){}}var Quetzal=IFF.subClass({init:function(t){if(this._super(t),t){if("IFZS"!==this.type)throw Error("Not a Quetzal savefile");for(var e=0,r=this.chunks.length;r>e;e++){var n=this.chunks[e].type,s=this.chunks[e].data;"CMem"===n||"UMem"===n?(this.memory=s,this.compressed="CMem"===n):"Stks"===n?this.stacks=s:"IFhd"===n&&(this.release=s.slice(0,2),this.serial=s.slice(2,8),this.checksum=s.slice(8,10),this.pc=s[10]<<16|s[11]<<8|s[12])}}},write:function(){this.type="IFZS";var t=this.pc,e=this.release.concat(this.serial,this.checksum,255&t>>16,255&t>>8,255&t);return this.chunks=[{type:"IFhd",data:e},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this._super()}});String.prototype.quote=function(){var t,e,r=this.length,n='"';for(e=0;r>e;e+=1)if(t=this.charAt(e),t>=" ")("\\"===t||'"'===t)&&(n+="\\"),n+=t;else switch(t){case"\b":n+="\\b";break;case"\f":n+="\\f";break;case"\n":n+="\\n";break;case"\r":n+="\\r";break;case"	":n+="\\t";break;default:t=t.charCodeAt(),n+="\\u00"+Math.floor(t/16).toString(16)+(t%16).toString(16)}return n+'"'};var CVS_VERSION="$Date: 2005/04/26 01:50:32 $",ENGINE_DESCRIPTION="Gnusto's interactive fiction engine",default_unicode_translation_table={155:228,156:246,157:252,158:196,159:214,160:220,161:223,162:187,163:171,164:235,165:239,166:255,167:203,168:207,169:225,170:233,171:237,172:243,173:250,174:253,175:193,176:201,177:205,178:211,179:218,180:221,181:224,182:232,183:236,184:242,185:249,186:192,187:200,188:204,189:210,190:217,191:226,192:234,193:238,194:244,195:251,196:194,197:202,198:206,199:212,200:219,201:229,202:197,203:248,204:216,205:227,206:241,207:245,208:195,209:209,210:213,211:230,212:198,213:231,214:199,215:254,216:240,217:222,218:208,219:163,220:339,221:338,222:161,223:191},reverse_unicode_table={},isNotConst=/\D/,temp_var=0,PARENT_REC=0,SIBLING_REC=1,CHILD_REC=2,CALLED_FROM_INTERRUPT=0;window||(this.window={});var dummy,t,t2,PARCHMENT_SECURITY_OVERRIDE=window.PARCHMENT_SECURITY_OVERRIDE,GNUSTO_EFFECT_INPUT='"RS"',GNUSTO_EFFECT_INPUT_CHAR='"RC"',GNUSTO_EFFECT_SAVE='"DS"',GNUSTO_EFFECT_RESTORE='"DR"',GNUSTO_EFFECT_QUIT='"QU"',GNUSTO_EFFECT_RESTART='"NU"',GNUSTO_EFFECT_WIMP_OUT='"WO"',GNUSTO_EFFECT_BREAKPOINT='"BP"',GNUSTO_EFFECT_FLAGS_CHANGED='"XC"',GNUSTO_EFFECT_PIRACY='"CP"',GNUSTO_EFFECT_STYLE='"SS"',GNUSTO_EFFECT_SOUND='"FX"',GNUSTO_EFFECT_SPLITWINDOW='"TW"',GNUSTO_EFFECT_SETWINDOW='"SW"',GNUSTO_EFFECT_ERASEWINDOW='"YW"',GNUSTO_EFFECT_ERASELINE='"YL"',GNUSTO_EFFECT_SETCURSOR='"SC"',GNUSTO_EFFECT_SETBUFFERMODE='"SB"',GNUSTO_EFFECT_SETINPUTSTREAM='"SI"',GNUSTO_EFFECT_GETCURSOR='"GC"',GNUSTO_EFFECT_PRINTTABLE='"PT"',handlers_v578={1:handleZ_je,2:handleZ_jl,3:handleZ_jg,4:handleZ_dec_chk,5:handleZ_inc_chk,6:handleZ_jin,7:handleZ_test,8:handleZ_or,9:handleZ_and,10:handleZ_test_attr,11:handleZ_set_attr,12:handleZ_clear_attr,13:handleZ_store,14:handleZ_insert_obj,15:handleZ_loadw,16:handleZ_loadb,17:handleZ_get_prop,18:handleZ_get_prop_addr,19:handleZ_get_next_prop,20:handleZ_add,21:handleZ_sub,22:handleZ_mul,23:handleZ_div,24:handleZ_mod,25:handleZ_call_2s,26:handleZ_call_2n,27:handleZ_set_colour,28:handleZ_throw,128:handleZ_jz,129:handleZ_get_sibling,130:handleZ_get_child,131:handleZ_get_parent,132:handleZ_get_prop_len,133:handleZ_inc,134:handleZ_dec,135:handleZ_print_addr,136:handleZ_call_1s,137:handleZ_remove_obj,138:handleZ_print_obj,139:handleZ_ret,140:handleZ_jump,141:handleZ_print_paddr,142:handleZ_load,143:handleZ_call_1n,176:handleZ_rtrue,177:handleZ_rfalse,178:handleZ_print,179:handleZ_print_ret,180:handleZ_nop,183:handleZ_restart,184:handleZ_ret_popped,185:handleZ_catch,186:handleZ_quit,187:handleZ_new_line,189:handleZ_verify,190:handleZ_illegal_extended,191:handleZ_piracy,224:handleZ_call_vs,225:handleZ_store_w,226:handleZ_storeb,227:handleZ_putprop,228:handleZ_read,229:handleZ_print_char,230:handleZ_print_num,231:handleZ_random,232:handleZ_push,233:handleZ_pull,234:handleZ_split_window,235:handleZ_set_window,236:handleZ_call_vs,237:handleZ_erase_window,238:handleZ_erase_line,239:handleZ_set_cursor,240:handleZ_get_cursor,241:handleZ_set_text_style,242:handleZ_buffer_mode,243:handleZ_output_stream,244:handleZ_input_stream,245:handleZ_sound_effect,246:handleZ_read_char,247:handleZ_scan_table,248:handleZ_not,249:handleZ_call_vn,250:handleZ_call_vn,251:handleZ_tokenise,252:handleZ_encode_text,253:handleZ_copy_table,254:handleZ_print_table,255:handleZ_check_arg_count,1e3:handleZ_saveV45678,1001:handleZ_restoreV45678,1002:handleZ_log_shift,1003:handleZ_art_shift,1004:handleZ_set_font,1009:handleZ_save_undo,1010:handleZ_restore_undo,1011:handleZ_print_unicode,1012:handleZ_check_unicode,1030:handleZ_gestalt,1031:handleZ_parchment},handlers_fixups={1:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},2:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},3:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},4:{26:0,27:0,28:0,143:handleZ_not,181:handleZ_saveV45678,182:handleZ_restoreV45678,185:handleZ_pop,190:0,191:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},5:"",6:void 0,7:"",8:""};GnustoEngine.prototype={loadStory:function ge_loadStory(t){this.m_memory=t,this._initial_setup()},loadSavedGame:function ge_loadSavedGame(t){function e(t,e){for(var r=s[t++],n=1;e>n;n++)r=r<<8|s[t++];return r}var r=new Quetzal(t),n=r.memory,s=r.stacks,i=r.pc;if(r.compressed){for(var _=[],a=0,o=0;n.length>a;){o>=this.m_original_memory.length&&gnusto_error(999,"overshoot in decompression");var h=n[a++];if(0==h){var c=n[a++]+1;_=_.concat(this.m_original_memory.slice(o,o+c)),o+=c}else _.push(h^this.m_original_memory[o++])}n=_}this.m_call_stack=[],this.m_gamestack=[],this.m_locals_stack=[],this.m_locals=[],this.m_result_targets=[];var m=0;m=e(7,1),this.m_gamestack_callbreaks=[];for(var l=m,u=8,d=0;m>d;d++)this.m_gamestack.push(e(u,2)),u+=2;for(;s.length>u;){this.m_call_stack.push(e(u,3)),u+=3;var f=s[u++],g=s[u++];16&f&&(g=-1);var p=15&f;this.m_locals_stack.unshift(p),this.m_result_targets.push(g);for(var v=s[u++]+1,b=0;v>1;)v>>=1,b++;this.m_param_counts.unshift(b),m=e(u,2),u+=2,l+=m,this.m_gamestack_callbreaks.push(l);for(var y=[],F=0;p>F;F++)y.push(e(u,2)),u+=2;this.m_locals=y.concat(this.m_locals);for(var d=0;m>d;d++)this.m_gamestack.push(e(u,2)),u+=2}for(var T=0;16>T;T++)this.m_locals.push(0);this.m_memory=n.concat(this.m_memory.slice(n.length));var E=(4>=this.m_version?1:3)+1;this.m_pc=i-E,3>=this.m_version?eval("var t=new Function('with(this){'+this._brancher('1')+'}');t.call(this);"):this._varcode_set(2,this.m_memory[this.m_pc++])},resetStory:function ge_resetStory(){this.m_memory=this.m_original_memory.slice(),this._initial_setup()},version:function ge_version(){gnusto_error(101,"'version' not implemented")},signature:function ge_signature(){gnusto_error(101,"'signature' not implemented")},cvsVersion:function ge_cvsVersion(){return CVS_VERSION.substring(7,26)},setGoldenTrail:function ge_setGoldenTrail(t){this.m_goldenTrail=t?1:0},setCopperTrail:function ge_setCopperTrail(t){this.m_copperTrail=t?1:0},effect:function ge_effect(t){return this.m_effects[t]},answer:function ge_answer(t,e){this.m_answers[t]=e},run:function ge_run(){var t=0,e=0,r,n=this.m_single_step?1:1e4;for(this.m_rebound&&(this.m_rebound(),this.m_rebound=0,this.m_rebound_args=[]),this.m_effects=[];0==this.m_effects.length;){if(e++>=n)return this.m_effects=["WO"],1;t=this.m_pc,this.m_jit[t]?r=this.m_jit[t]:(r=eval("with (this) {dummy="+this._compile()+"}"),t>=this.m_stat_start&&(this.m_jit[t]=r)),r()}},walk:function ge_walk(){gnusto_error(101,"'walk' not implemented")},setRandomSeed:function ge_setRandomSeed(t){t>0?this._random_number(-t):this._random_number(t)},saveGame:function ge_saveGame(){function t(t,e){for(var r=[],n=0;e>n;n++)r[e-n-1]=255&t,t>>=8;return r}var e=this.m_state_to_save,r=[],n=0,s=this.m_locals.length-16,i=0,_=[0,0,0,0,0,0],a=new Quetzal;a.release=e.m_memory.slice(2,4),a.serial=e.m_memory.slice(18,24),a.checksum=e.m_memory.slice(28,30),a.pc=e.m_pc,a.compressed=1;for(var o=0,h=this.m_stat_start;h>o;o++)e.m_memory[o]==this.m_original_memory[o]?(n++,256==n&&(r.push(0),r.push(255),n=0)):(0!=n&&(r.push(0),r.push(n-1),n=0),r.push(e.m_memory[o]^this.m_original_memory[o]));0!=n&&(r.push(0),r.push(n-1)),a.memory=r,_=_.concat(t(this.m_gamestack_callbreaks[0],2));for(var c=0;this.m_gamestack_callbreaks[0]>c;c++)_=_.concat(t(this.m_gamestack[i++],2));for(var m=0;this.m_call_stack.length>m;m++){_=_.concat(t(this.m_call_stack[m],3));var l=this.m_locals_stack[this.m_locals_stack.length-(m+1)],u=l,d=this.m_result_targets[m],f=this.m_param_counts[this.m_param_counts.length-(m+1)],g=this.m_gamestack_callbreaks[m]-i;-1==d&&(d=0,u|=16),_=_.concat([u,d,(1<<f)-1,255&g>>8,255&g]),s-=l;for(var p=0;l>p;p++)_=_.concat(t(this.m_locals[s+p],2));for(var c=0;g>c;c++)_=_.concat(t(this.m_gamestack[i++],2))}return a.stacks=_,this.m_quetzal_image=a.write(),this.m_quetzal_image.length},saveGameData:function ge_saveGameData(){var t=this.m_quetzal_image;return this.m_quetzal_image=0,t},architecture:function ge_architecture(){return"none"},piracy:function ge_piracy(){return-1},tandy:function ge_tandy(){return-1},status:function ge_status(){return"this is the status, hurrah!"},getStatusLine:function ge_getStatusLine(t){var e=this.getUnsignedWord(this.m_vars_start),r=this.getUnsignedWord(this.m_property_list_addr_start+this.m_object_size*e),n=this._zscii_from(r+1);if(n.length>t){n=n.substring(0,t-3);var s="...",i=""}else{if(this.m_version>3&&2==(2&this.getByte(1))){var _=this.getUnsignedWord(this.m_vars_start+2),a=this.getUnsignedWord(this.m_vars_start+4);if(10>a)var s=_+":0"+a;else var s=_+":"+a}else var s="Score: "+this.getUnsignedWord(this.m_vars_start+2)+"  Moves: "+this.getUnsignedWord(this.m_vars_start+4);n.length+s.length+1>t&&(s=" S:"+this.getUnsignedWord(this.m_vars_start+2)+" M:"+this.getUnsignedWord(this.m_vars_start+4),n.length+s.length+1>t&&(s=" "+this.getUnsignedWord(this.m_vars_start+2)+"/"+this.getUnsignedWord(this.m_vars_start+4)),n.length+s.length+1>t&&(s=""));for(var i="";t>n.length+s.length+i.length;)i+=" "}return n+i+s},gestalt:function(t,e){return 1==t?258:32==t&&(0==e||1==e&&PARCHMENT_SECURITY_OVERRIDE)?1:0},op_parchment:function(t,e){var r=this;return 1==t&&PARCHMENT_SECURITY_OVERRIDE?(1==e?(r.op_parchment_data.saved_buffer=r.m_console_buffer,r.m_console_buffer="",r.op_parchment_data.raw_eval=1):(r.op_parchment_data.raw_eval&&(eval(r.m_console_buffer),r.m_console_buffer=r.op_parchment_data.saved_buffer),r.op_parchment_data.raw_eval=0),1):0},_initial_setup:function ge_initial_setup(){this.m_jit=[],this.m_compilation_running=0,this.m_gamestack=[],this.m_gamestack_callbreaks=[],this.m_call_stack=[],this.m_locals=[],this.m_locals_stack=[],this.m_param_counts=[],this.m_result_targets=[],this.m_goldenTrail=0,this.m_copperTrail=0,this.m_version=this.m_memory[0],this.m_original_memory=this.m_memory.slice(),this.m_himem=this.getUnsignedWord(4),this.m_pc=this.getUnsignedWord(6),this.m_dict_start=this.getUnsignedWord(8),this.m_objs_start=this.getUnsignedWord(10),this.m_vars_start=this.getUnsignedWord(12),this.m_stat_start=this.getUnsignedWord(14),this.m_abbr_start=this.getUnsignedWord(24),this.m_version>=4?(this.m_alpha_start=this.getUnsignedWord(52),this.m_object_tree_start=this.m_objs_start+112,this.m_property_list_addr_start=this.m_object_tree_start+12,this.m_object_size=14):(this.m_alpha_start=0,this.m_object_tree_start=this.m_objs_start+53,this.m_property_list_addr_start=this.m_object_tree_start+7,this.m_object_size=9),this.m_hext_start=this.getUnsignedWord(54),3>=this.m_version?(this.m_pc_translate_for_routine=pc_translate_v123,this.m_pc_translate_for_string=pc_translate_v123):5>=this.m_version?(this.m_pc_translate_for_routine=pc_translate_v45,this.m_pc_translate_for_string=pc_translate_v45):7>=this.m_version?(this.m_routine_start=8*this.getUnsignedWord(40),this.m_string_start=8*this.getUnsignedWord(42),this.m_pc_translate_for_routine=pc_translate_v67R,this.m_pc_translate_for_string=pc_translate_v67S):8==this.m_version?(this.m_pc_translate_for_routine=pc_translate_v8,this.m_pc_translate_for_string=pc_translate_v8):gnusto_error(170,"impossible: unknown z-version got this far"),this.m_version in handlers_fixups||gnusto_error(311,"unknown z-machine version");var t=handlers_fixups[this.m_version];switch(typeof t){case"undefined":gnusto_error(101,"z-machine version not implemented");break;case"string":this.m_handlers=handlers_v578;break;case"object":this.m_handlers={};for(var e in handlers_v578)this.m_handlers[e]=handlers_v578[e];for(var r in t)"function"==typeof t[r]?this.m_handlers[r]=t[r]:delete this.m_handlers[r];break;default:gnusto_error(170,"impossible: weird stuff in fixups table")}this.m_separator_count=this.m_memory[this.m_dict_start];for(var n=0;this.m_separator_count>n;n++)this.m_separators[n]=this._zscii_char_to_ascii(this.m_memory[this.m_dict_start+n+1]);if(this.m_hext_start>0&&(this.m_unicode_start=this.getUnsignedWord(this.m_hext_start+6),this.m_unicode_start>0)){this.m_custom_unicode_charcount=this.m_memory[this.m_unicode_start],this.m_unicode_start+=1;for(var n=0;this.m_custom_unicode_charcount>n;n++)reverse_unicode_table[this.getUnsignedWord(this.m_unicode_start+2*n)]=n+155}if(!(this.m_unicode_start>0))for(var n in default_unicode_translation_table)reverse_unicode_table[default_unicode_translation_table[n]]=n;this.m_rebound=0,this.m_rebound_args=[],this.m_output_to_console=1,this.m_streamthrees=[],this.m_output_to_script=0,this.m_console_buffer="",this.m_transcript_buffer="",this.m_zalphabet[0]="abcdefghijklmnopqrstuvwxyz",this.m_zalphabet[1]="ABCDEFGHIJKLMNOPQRSTUVWXYZ",this.m_zalphabet[2]=1==this.m_version?"T0123456789.,!?_#'\"/\\<-:()":"T\n0123456789.,!?_#'\"/\\-:()";var s,i;if(this.m_alpha_start>0)for(var _=0;3>_;_++){for(var a="",o=0;26>o;o++)i=this.m_memory[this.m_alpha_start+26*_+o],i>=155&&251>=i?a+=0==this.m_unicode_start?String.fromCharCode(default_unicode_translation_table[i]):this.m_custom_unicode_charcount>=i-154?String.fromCharCode(this.getUnsignedWord(this.m_unicode_start+2*(i-155))):" ":(s=String.fromCharCode(i),"^"==s&&(s="\n"),a+=s);this.m_zalphabet[_]=a}for(var n=0;16>n;n++)this.m_locals[n]=0;this.m_printing_header_bits=0,this.m_leftovers="",this.m_memory[30]=1,this.m_memory[31]=0,this.m_memory[1]|=29,this.m_memory[38]=1,this.m_memory[39]=1,this.m_memory[50]=1,this.m_memory[51]=PARCHMENT_SECURITY_OVERRIDE?2:0},_unsigned2signed:function ge_unsigned2signed(t){return(32768&t?-65536:0)|t},_signed2unsigned:function ge_signed2unsigned(t){return 65535&t},getByte:function ge_getbyte(t){if(this.m_value_asserts){(null==t||t===!0||t===!1||0>t||t>=this.m_original_memory.length)&&this.logger("getByte addr",t);var e=this.m_memory[t];(null==e||e===!0||e===!1||0>e||e>255)&&this.logger("getByte byte",e)}return this.m_memory[t]},setByte:function ge_setByte(t,e){this.m_value_asserts&&(null==e||e===!0||e===!1||0>e||e>=this.m_stat_start)&&this.logger("setByte addr",e),this.m_memory[e]=255&t},getWord:function ge_getWord(t){if(this.m_value_asserts){(null==t||t===!0||t===!1||0>t||t>=this.m_original_memory.length)&&this.logger("getWord addr",t);var e=this.m_memory[t];(null==e||e===!0||e===!1||0>e||e>255)&&this.logger("getWord high byte",e);var e=this.m_memory[t+1];(null==e||e===!0||e===!1||0>e||e>255)&&this.logger("getWord low byte",e)}var r=this.m_memory[t]<<8|this.m_memory[t+1];return(32768&r?-65536:0)|r},getUnsignedWord:function ge_getUnsignedWord(t){if(this.m_value_asserts){(null==t||t===!0||t===!1||0>t||t>=this.m_original_memory.length)&&this.logger("getUnsignedWord addr",t);var e=this.m_memory[t];(null==e||e===!0||e===!1||0>e||e>255)&&this.logger("getUnsignedWord high byte",e);var e=this.m_memory[t+1];(null==e||e===!0||e===!1||0>e||e>255)&&this.logger("getUnsignedWord low byte",e)}return this.m_memory[t]<<8|this.m_memory[t+1]},setWord:function ge_setWord(t,e){this.m_value_asserts&&(null==e||e===!0||e===!1||0>e||e>=this.m_stat_start)&&this.logger("setWord",e),this.m_memory[e]=255&t>>8,this.m_memory[e+1]=255&t},_handle_variable_parameters:function ge_handle_var_parameters(t,e,r){var n,s=0,i="";for(1==r&&(e=255|e<<8);;){var _=49152&e;
if(49152==_)return i;0==_?(t[s++]=this.getUnsignedWord(this.m_pc),this.m_pc+=2):16384==_?t[s++]=this.m_memory[this.m_pc++]:32768==_&&(n=this._code_for_varcode(this.m_memory[this.m_pc++]),i+=n[0],t[s++]=n[1]),e=3|e<<2}},_compile:function ge_compile(){this.m_compilation_running=1;var t,e,r="",n=this.m_pc;temp_var=0;do{var s=[],i=this.m_pc;(null==i||0>i||i>=this.m_original_memory.length)&&gnusto_error(206,i);var _=this.m_memory[this.m_pc++];if(0==_)gnusto_error(201);else if(190==_)_=1e3+this.m_memory[this.m_pc++],r+=this._handle_variable_parameters(s,this.m_memory[this.m_pc++],1);else if(128&_)if(64&_)if(32&_||(_&=31),250==_||236==_){var a=this.getUnsignedWord(this.m_pc);this.m_pc+=2,r+=this._handle_variable_parameters(s,a,2)}else r+=this._handle_variable_parameters(s,this.m_memory[this.m_pc++],1);else switch(48&_){case 0:s[0]=this.getUnsignedWord(this.m_pc),this.m_pc+=2,_=128|15&_;break;case 16:s[0]=this.m_memory[this.m_pc++],_=128|15&_;break;case 32:t=this._code_for_varcode(this.m_memory[this.m_pc++]),r+=t[0],s[0]=t[1],_=128|15&_;break;case 48:_=176|15&_}else 64&_?(t=this._code_for_varcode(this.m_memory[this.m_pc++]),r+=t[0],s[0]=t[1]):s[0]=this.m_memory[this.m_pc++],32&_?(t=this._code_for_varcode(this.m_memory[this.m_pc++]),r+=t[0],s[1]=t[1]):s[1]=this.m_memory[this.m_pc++],_&=31;this.m_handlers[_]?r=r+this.m_handlers[_](this,s)+";":_>=1128&&1255>=_&&"special_instruction_EXT"+(_-1e3)in this?r=r+this["special_instruction_EXT"+(_-1e3)](s)+";":gnusto_error(200,this.m_pc.toString(16))}while(this.m_compilation_running);(this.m_single_step||this.m_debug_mode)&&(r=r+"m_pc="+this.m_pc),r=r.replace(/m_gamestack\.push\(([^;]+)\);var tmp_(\d+) = m_gamestack\.pop\(\);/,"var tmp_$2 = $1;"),e="function JIT_"+n.toString(16)+"_"+n;var o=function(t){for(;!vm_functions[t]&&t>0;)t--;return vm_functions[t]};return e+=window.vm_functions?"_"+o(n):"",e+"(){"+r+"}"},_param_count:function ge_param_count(){return this.m_param_counts[0]},_set_output_stream:function ge_set_output_stream(t,e){if(t=this._unsigned2signed(t),0==t);else if(1==t)this.m_output_to_console=1;else if(2==t)this.m_memory[17]|=1;else if(3==t)this.m_streamthrees.length>15&&gnusto_error(202),this.m_streamthrees.unshift([e,e+2]);else if(4==t)this.m_output_to_script=1;else if(-1==t)this.m_output_to_console=0;else if(-2==t)this.m_memory[17]&=-2;else if(-3==t){1>this.m_streamthrees.length&&gnusto_error(203);var r=this.m_streamthrees.shift();this.setWord(r[1]-r[0]-2,r[0])}else-4==t?this.m_output_to_script=0:gnusto_error(204,t)},_trunc_divide:function ge_trunc_divide(t,e){var r;return t=this._unsigned2signed(t),e=this._unsigned2signed(e),0==e?(gnusto_error(701),0):(r=t/e,r>0?65535&Math.floor(r):65535&Math.ceil(r))},_trunc_modulo:function ge_trunc_modulo(t,e){return t=this._unsigned2signed(t),e=this._unsigned2signed(e),0==e?(gnusto_error(701),0):65535&t%e},_zscii_char_to_ascii:function ge_zscii_char_to_ascii(t){0>t&&gnusto_error(702,t);var e;if(0==t)return"";if(10==t||13==t)return"\n";if(t>=32&&126>=t||0==t)e=t;else{if(!(t>=155&&251>=t))return"*";if(0==this.m_unicode_start)return String.fromCharCode(default_unicode_translation_table[t]);if(this.m_custom_unicode_charcount>=t-154)return String.fromCharCode(this.getUnsignedWord(this.m_unicode_start+2*(t-155)));gnusto_error(703,t)}return String.fromCharCode(e)},_ascii_code_to_zscii_code:function ge_ascii_char_to_zscii(t){var e={10:13,13:13,37:131,38:129,39:132,40:130};if(isNaN(t)){if(t.keyCode&&e[t.keyCode])return e[t.keyCode];var t=t.charCode}if(10==t||13==t)return 13;if(t>31&&127>t||0==t)return t;0>t&&gnusto_error(702,"Illegal unicode character:"+t);var r=reverse_unicode_table[t];return r||(r=42),r},_random_number:function ge_random_number(t){if(t=this._unsigned2signed(t),0==t)return this.m_random_use_seed=this.m_random_use_sequence=0,0;if(-999>t)return this.m_random_state=Math.abs(t),this.m_random_use_seed=1,this.m_random_use_sequence=0,0;if(0>t)return this.m_random_sequence_max=Math.abs(t)-1,this.m_random_state=0,this.m_random_use_seed=0,this.m_random_use_sequence=1,0;if(this.m_random_use_seed)return this.m_random_state--,1+Math.round(8.71*Math.abs(Math.tan(this.m_random_state))*t)%t;if(this.m_random_use_sequence){var e=this.m_random_state;return this.m_random_state=this.m_random_state+1,this.m_random_state>this.m_random_sequence_max&&(this.m_random_state=0),1+e%t}return 1+Math.round((t-1)*Math.random())},_func_gosub:function ge_gosub(t,e,r,n){this.m_call_stack.push(r),this.m_pc=t;var s=this.m_memory[this.m_pc++];if(5>this.m_version){for(var i=[],_=0;s>_;_++)e.length>_?i.push(e[_]):i.push(this.getUnsignedWord(this.m_pc)),this.m_pc+=2;this.m_locals=i.concat(this.m_locals)}else for(var a=s;a>0;a--)e.length>=a?this.m_locals.unshift(e[a-1]):this.m_locals.unshift(0);this.m_locals_stack.unshift(s),this.m_param_counts.unshift(e.length),this.m_result_targets.push(n),this.m_gamestack_callbreaks.push(this.m_gamestack.length),0==t&&this._func_return(0)},_func_interrupt:function ge_interrupt(t,e){this.m_interrupt_information.push({on_return:e,rebound:this.m_rebound,rebound_args:this.m_rebound_args,engine:this,pc:this.m_pc,effects:this.m_effects}),this._func_gosub(t,[],CALLED_FROM_INTERRUPT,-1)},_tokenise:function ge_tokenise(t,e,r,n){function s(t,e,r){function n(t,e,r){for(var n,s,i=0;;){if(i==e.length)return 0;if(n=t.m_memory[r+i],s=e.charCodeAt(i),n!=s)return s>n?-1:1;i++}}var s=t.m_memory[r+t.m_separator_count+1],i=t.getWord(r+t.m_separator_count+2),_=t.m_dict_start+t.m_separator_count+4,a=1;if(0>i&&(a=0,i=-i),e=t._into_zscii(e),a)for(var o,h,c,m=0,l=i-1;;){if(o=m+Math.round((l-m)/2),h=_+o*s,c=n(t,e,h),0>c){if(m==l)return 0;m=o+1}else{if(!(c>0))return h;if(m==l)return 0;l=o-1}if(m>l)return 0}else for(var u=0;i>u;u++){var d=_+u*s;if(0==n(t,e,d))return d}return 0}function i(t,e,r,i){var o=s(t,r,e);return n&&0==o?a+=4:(t.setWord(o,a),a+=2,t.setByte(r.length,a++),t.setByte(i,a++)),_++,1}var _=0,a=e+2,o=e+1;isNaN(r)&&(r=0),isNaN(n)&&(n=0);var h=this.m_memory[t],c="";if(0==r&&(r=this.m_dict_start),4>=this.m_version){h++;for(var m=t+1;;){var l=this.m_memory[m++];if(0==l)break;c+=String.fromCharCode(l)}}else for(var u=0;this.m_memory[t+1]>u;u++)c+=String.fromCharCode(this.m_memory[t+2+u]);var d,f=[],g="",p=0;d=4>=this.m_version?1:2;for(var v=0;c.length>v;v++)" "==c.charAt(v)?""!=g&&(f[p]=g,i(this,r,f[p],v-f[p].length+d),p++,g=""):this._is_separator(c.charAt(v))?(""!=g&&(f[p]=g,i(this,r,f[p],v-f[p].length+d),p++),f[p]=c.charAt(v),i(this,r,f[p],v+d),p++,g=""):g+=c.charAt(v);""!=g&&(f[p]=g,i(this,r,f[p],v-f[p].length+d)),this.setByte(_,o)},_aread:function ge_aread(t,e,r,n){e&=65535,r&=65535;var s,i,_;4>=this.m_version?(s=this.m_memory[e]+1,i=n.substring(0,s).toLowerCase(),_=e+1,this.setByte(0,e+1+i.length)):(s=this.m_memory[e],i=n.substring(0,s).toLowerCase(),_=e+2,this.setByte(i.length,e+1));for(var a=0;i.length>a;a++)this.setByte(this._ascii_code_to_zscii_code(i.charCodeAt(a)),_+a);return(0!=r||5>this.m_version)&&this._tokenise(e,r,0,0),13==t?10:t},_terminating_characters:function ge_terminating_characters(){if(5>this.m_version)return"\r";for(var t=this.getUnsignedWord(46),e="\r";;){var r=this.m_memory[t++];if(0==r)break;(r>=129&&154>=r||r>=252)&&(e+=String.fromCharCode(r))}return e},_func_return:function ge_func_return(t){this.m_locals=this.m_locals.slice(this.m_locals_stack.shift()),this.m_param_counts.shift(),this.m_pc=this.m_call_stack.pop(),this.m_gamestack.length=this.m_gamestack_callbreaks.pop();var e=this.m_result_targets.pop();if(-1!=e&&null!=t&&(0==e?this.m_gamestack.push(t):16>e?this.m_locals[e-1]=t:this.setWord(t,this.m_vars_start+2*(e-16))),this.m_pc==CALLED_FROM_INTERRUPT){var r=this.m_interrupt_information.pop();this.m_pc=r.pc,r.on_return(r,t)}},_throw_stack_frame:function throw_stack_frame(t){for((t>this.m_call_stack.length||1>t)&&gnusto_error(207,t);this.m_call_stack.length>t-1;)this._func_return(null)},_get_prop_addr:function ge_get_prop_addr(t,e){if(0==t)return 0;var r=this._property_search(t,e,-1);return r[2]?r[0]:0},_get_prop_len:function ge_get_prop_len(t){if((null==t||t===!0||t===!1||0>t||t>=this.m_stat_start)&&this.logger("get_prop_len",t),0==t)return 0;if(4>this.m_version)return 1+(this.m_memory[t-1]>>5);var e=this.m_memory[t-1];return 128&e?(e=63&e,0==e?64:e):64&e?2:1},_get_next_prop:function ge_get_next_prop(t,e){if(0==t)return 0;var r=this._property_search(t,-1,e);return r[2]?r[3]:r[4]?0:(gnusto_error(205,e),gnusto_error(173),void 0)},_get_prop:function ge_get_prop(t,e){if(0==t)return 0;var r=this._property_search(t,e,-1);return this.m_value_asserts&&(null==r[0]||r[0]===!0||r[0]===!1||0>r[0]||r[0]>=this.m_stat_start)&&this.logger("get_prop",r[0]),1==r[1]?this.m_memory[r[0]]:2==r[1]?this.m_memory[r[0]]<<8|this.m_memory[r[0]+1]:this.getUnsignedWord(r[0])},_property_search:function ge_property_search(t,e,r){var n=this.getUnsignedWord(this.m_property_list_addr_start+t*this.m_object_size);n=n+2*this.m_memory[n]+1;for(var s=0;;){var i=1,_=this.m_memory[n++];if(4>this.m_version?(i=(_>>5)+1,_=31&_):(128&_?(i=63&this.m_memory[n++],0==i&&(i=64)):64&_&&(i=2),_=63&_),_==e||s==r)return[n,i,1,_,0];if(e>_)return e>0?[this.m_objs_start+2*(e-1),2,0,e,0]:[-1,-1,0,e,s==e];n+=i,s=_}gnusto_error(175)},_set_attr:function ge_set_attr(t,e){if(0!=t){var r=this.m_object_tree_start+t*this.m_object_size+(e>>3),n=this.m_memory[r];this.setByte(n|128>>e%8,r)}},_clear_attr:function ge_clear_attr(t,e){if(0!=t){var r=this.m_object_tree_start+t*this.m_object_size+(e>>3),n=this.m_memory[r];this.setByte(n&~(128>>e%8),r)}},_test_attr:function ge_test_attr(t,e){return 0==t?0:this.m_memory[this.m_object_tree_start+t*this.m_object_size+(e>>3)]&128>>e%8?1:0},_put_prop:function put_prop(t,e,r){if(0!=t){var n=this._property_search(t,e,-1);n[2]||gnusto_error(704),1==n[1]?this.setByte(r,n[0]):2==n[1]?this.setWord(r,n[0]):gnusto_error(705)}},_get_older_sibling:function ge_get_older_sibling(t){if(0==t)return 0;var e=this._get_child(this._get_parent(t));if(t==e)return 0;for(;e;){var r=this._get_sibling(e);if(r==t)return e;e=r}return 0},_insert_obj:function ge_insert_obj(t,e){var r=this._get_parent(t),n=this._get_older_sibling(t),s=this._get_sibling(t);r&&this._get_child(r)==t&&this._set_child(r,s),n&&this._set_sibling(n,s),this._set_parent(t,e),e&&(this._set_sibling(t,this._get_child(e)),this._set_child(e,t))},_remove_obj:function ge_remove_obj(t){this._insert_obj(t,0)},_get_family:function ge_get_family(t,e){return 0==t?0:4>this.m_version?this.m_memory[this.m_object_tree_start+4+e+t*this.m_object_size]:this.getUnsignedWord(this.m_object_tree_start+6+2*e+t*this.m_object_size)},_get_parent:function ge_get_parent(t){return this._get_family(t,PARENT_REC)},_get_child:function ge_get_child(t){return this._get_family(t,CHILD_REC)},_get_sibling:function ge_get_sibling(t){return this._get_family(t,SIBLING_REC)},_set_family:function ge_set_family(t,e,r){4>this.m_version?this.setByte(e,this.m_object_tree_start+4+r+t*this.m_object_size):this.setWord(e,this.m_object_tree_start+6+2*r+t*this.m_object_size)},_set_parent:function ge_set_parent(t,e){this._set_family(t,e,PARENT_REC)},_set_child:function ge_set_child(t,e){this._set_family(t,e,CHILD_REC)},_set_sibling:function ge_set_sibling(t,e){this._set_family(t,e,SIBLING_REC)},_obj_in:function ge_obj_in(t,e){return this._get_parent(t)==e},_copy_table:function ge_copy_table(t,e,r){if(r=this._unsigned2signed(r),0==e)for(var n=0;r>n;n++)this.setByte(0,n+t);else{var s=0;if(0>r?(r=-r,s=1):s=t>e?1:0,s)for(var n=0;r>n;n++)this.setByte(this.m_memory[t+n],e+n);else for(var n=r-1;n>=0;n--)this.setByte(this.m_memory[t+n],e+n)}},_scan_table:function ge_scan_table(t,e,r,n){var s=127&n,i=128==(128&n),_=e+r*s;if(i)for(;_>e;){if((255&this.m_memory[65535&e])==(255&t>>8)&&(255&this.m_memory[65535&e+1])==(255&t))return e;e+=s}else for(;_>e;){if((255&this.m_memory[65535&e])==(65535&t))return e;e+=s}return 0},_print_table:function ge_print_table(t,e,r,n){for(var s=[],i=0;r>i;i++){for(var _="",a=0;e>a;a++)0>t&&(t&=65535),_+=this._zscii_char_to_ascii(this.m_memory[t++]);s.push(_),t+=n}var o=["PT",s.length];return o=o.concat(s)},_zscii_from:function ge_zscii_from(t,e,r){if(t in this.m_jit)return r?this.m_jit[t]:this.m_jit[t][0];var n="",s=1,i=t,_=0,a=_,o=-2,h=0;e||(e=65535);for(var c=t+e;s;){var m=this.getUnsignedWord(t);t+=2,s=0==(32768&m)&&c>t;for(var l=2;l>=0;l--){var u=31&m>>5*l;h?(n+=this._zscii_from(2*this.getUnsignedWord(2*(32*(h-1)+u)+this.m_abbr_start)),h=0,a=_):-2==o?u>5?2==a&&6==u?o=-1:(n+=this.m_zalphabet[a].charAt(u-6),a=_):0==u?(n+=" ",a=_):4>u?this.getByte(0)>2?h=u:2==u?(a+=1,a>2&&(a=0)):3==u?(a-=1,0>a&&(a=2)):2==this.getByte(0)?h=1:(n+="\n",a=_):this.getByte(0)>2?a=u-3:(4==u?(_+=1,_>2&&(_=0)):(_-=1,0>_&&(_=2)),a=_):-1==o?o=u:(n+=this._zscii_char_to_ascii((o<<5)+u),o=-2,a=_)}}return i>=this.m_stat_start&&(this.m_jit[i]=[n,t]),r?[n,t]:n},_encode_text:function ge_encode_text(t,e,r,n){t=65535&t+r;for(var s="";e>0;){var i=this.m_memory[t];if(0==i)break;s+=String.fromCharCode(i),t++,e--}for(var _=this._into_zscii(s),a=0;_.length>a;a++){var o=_[a].charCodeAt(0);this.setByte(o,n++)}},_into_zscii:function ge_into_zscii(t){function e(t){if(s.push(t),3==s.length){var e=s[0]<<10|s[1]<<5|s[2];n.length==r-2&&(e|=32768),n=n+String.fromCharCode(e>>8)+String.fromCharCode(255&e),s=[]}}var r,n="",s=[];r=4>this.m_version?4:6;for(var i,_,a=0;t.length>a&&r>n.length;){if(i=t.charCodeAt(a++),i>=65&&90>=i)i+=32;else if(i>154)if(0==this.m_unicode_start)i>=158&&160>=i||i>=167&&168>=i||i>=208&&210>=i?i-=3:i>=175&&180>=i?i-=6:i>=186&&190>=i||i>=196&&200>=i?i-=5:217==i||218==i?i-=2:(202==i||204==i||212==i||214==i||221==i)&&(i-=1);else{var o=this._ascii_code_to_zscii_code(this._zscii_char_to_ascii(i).toLowerCase().charCodeAt(0));o>0&&251>=o&&o!="*".charCodeAt(0)&&(i=o)}var h=String.fromCharCode(this._zscii_char_to_ascii(i).charCodeAt(0));_=this.m_zalphabet[0].indexOf(h),-1!=_?e(_+6):(_=this.m_zalphabet[1].indexOf(h),-1!=_?(this.getByte(0)>2?e(4):e(2),e(_+6)):(_=this.m_zalphabet[2].indexOf(h),-1!=_?(this.getByte(0)>2?e(5):e(3),e(_+6)):(this.getByte(0)>2?e(5):e(3),e(6),e(i>>5),e(31&i))))}for(;r>n.length;)e(5);return n.substring(0,r)},_name_of_object:function ge_name_of_object(t){if(0==t)return"<void>";var e=this.m_property_list_addr_start+t*this.m_object_size;return this._zscii_from(this.getUnsignedWord(e)+1)},_print_leftovers:function ge_print_leftovers(){this._zOut(this.m_leftovers),this.m_leftovers=""},_zOut:function ge_zOut(t){if(this.m_streamthrees.length){this.m_streamthrees[0];for(var e=this.m_streamthrees[0][1],r=0;t.length>r;r++)this.setByte(this._ascii_code_to_zscii_code(t.charCodeAt(r)),e++);this.m_streamthrees[0][1]=e}else{var n=3&this.m_memory[17],s=n!=this.m_printing_header_bits;if(this.m_printing_header_bits=n,s)return this.m_leftovers=t,this.m_rebound=this._print_leftovers,1;this.m_output_to_console&&(this.m_console_buffer=this.m_console_buffer+t),1&n&&(this.m_transcript_buffer=this.m_transcript_buffer+t)}return 0},consoleText:function ge_console_text(){var t=this,e=t.m_console_buffer.replace("\0","","g");return t.op_parchment_data.raw_eval?"":(t.m_console_buffer="",e)},_transcript_text:function ge_transcript_text(){var t=this.m_transcript_buffer.replace("\0","","g");return this.m_transcript_buffer="",t},_is_separator:function ge_IsSeparator(t){for(var e=0;this.m_separator_count>e;e++)if(t==this.m_separators[e])return 1;return 0},_code_for_varcode:function ge_code_for_varcode(t){var e,r="";if(0==t)r="var tmp_"+ ++temp_var+" = m_gamestack.pop();",e="tmp_"+temp_var;else if(16>t)e="m_locals["+(t-1)+"]";else{var n=this.m_vars_start+2*(t-16),s=n+1,i="tmp_"+ ++temp_var;r="var "+i+" = (m_memory["+n+"] << 8) | m_memory["+s+"];",e=i}return[r,e]},_varcode_set:function ge_varcode_set(t,e){0==e?this.m_gamestack.push(t):16>e?this.m_locals[e-1]=t:this.setWord(t,this.m_vars_start+2*(e-16))},_brancher:function ge_brancher(t){var e=1,r=this.m_memory[this.m_pc++],n=63&r;128&r&&(e=0),64&r||(n=n<<8|this.m_memory[this.m_pc++],8192&n&&(n=-8192|8191&n));var s=t;return s=e?"if(!("+s+"))":"if("+s+")",0==n?s+"{_func_return(0);return;}":1==n?s+"{_func_return(1);return;}":(n=this.m_pc+n-2,s+"{m_pc="+n+";return;}")},_storer:function ge_storer(t){var e=this.m_memory[this.m_pc++];return t.substring&&"_func_gosub"==t.substring(0,11)?(this.m_compilation_running=0,",-1)"!=t.substring(t.length-4)&&gnusto_error(100,t),t.substring(0,t.length-3)+e+")"):0==e?"m_gamestack.push("+t+")":16>e?"m_locals["+(e-1)+"]="+t:"setWord("+t+","+(this.m_vars_start+2*(e-16))+")"},_generate_gosub:function call_vn(t,e,r){this.m_compilation_running=0;var n=-1;return r&&(n=this.m_memory[this.m_pc++]),"_func_gosub("+this.m_pc_translate_for_routine(t)+","+"["+(""+e)+"],"+this.m_pc+","+n+")"},_handler_zOut:function ge_handler_zOut(t,e){var r;return r=e?"_func_return(1)":"m_pc=0x"+this.m_pc.toString(16),"if(_zOut("+t+")){"+r+";m_effects=["+GNUSTO_EFFECT_FLAGS_CHANGED+"];return 1}"},_handler_print:function ge_handler_print(t,e){var r=this._zscii_from(this.m_pc,65535,1),n=r[0];return t&&(n+=t),n=n.quote(),this.m_pc=r[1],this._handler_zOut(n,e)},_log_shift:function ge_log_shift(t,e){return 32768&e?65535&t>>>65536-e:65535&t<<e},_art_shift:function ge_art_shift(t,e){return t=this._unsigned2signed(t),32768&e?65535&t>>65536-e:65535&t<<e},_touch:function ge_touch(t){this.m_goldenTrail&&this.logger("pc",t.toString(16)),this.m_pc=t},_save_undo:function ge_save_undo(t){return this.m_undo.push({m_call_stack:this.m_call_stack.slice(),m_locals:this.m_locals.slice(),m_locals_stack:this.m_locals_stack.slice(),m_param_counts:this.m_param_counts.slice(),m_result_targets:this.m_result_targets.slice(),m_gamestack:this.m_gamestack.slice(),m_gamestack_callbreaks:this.m_gamestack_callbreaks.slice(),m_memory:this.m_memory.slice(0,this.m_stat_start),m_resultvar:this.m_memory[t],m_pc:t+1}),1},_restore_undo:function ge_restore_undo(){if(0==this.m_undo.length)return 0;var t=this.m_undo.pop();this.m_call_stack=t.m_call_stack,this.m_locals=t.m_locals,this.m_locals_stack=t.m_locals_stack,this.m_param_counts=t.m_param_counts,this.m_result_targets=t.m_result_targets,this.m_gamestack=t.m_gamestack,this.m_gamestack_callbreaks=t.m_gamestack_callbreaks;var e=t.m_memory;return this.m_memory=e.concat(this.m_memory.slice(e.length)),this._varcode_set(2,t.m_resultvar),this.m_pc=t.m_pc,1},_saveable_state:function ge_saveable_state(t){var e={m_memory:this.m_memory.slice(0,this.m_stat_start),m_pc:this.m_pc+t,m_call_stack:this.m_call_stack.slice(),m_locals:this.m_locals.slice(),m_locals_stack:this.m_locals_stack.slice(),m_param_counts:this.m_param_counts.slice(),m_result_targets:this.m_result_targets.slice(),m_gamestack:this.m_gamestack.slice(),m_gamestack_callbreaks:this.m_gamestack_callbreaks.slice()};return e},_verify:function ge_verify(){for(var t=0,e=this.m_original_memory[28]<<8|this.m_original_memory[29],r=64;this.m_original_memory.length>r;r++)t+=this.m_original_memory[r];return(65535&t)==e},m_local_game_file:0,m_memory:[],m_handlers:0,m_jit:[],m_goldenTrail:0,m_copperTrail:0,m_compilation_running:0,m_gamestack:0,m_gamestack_callbreaks:[],m_himem:0,m_pc:0,m_dict_start:0,m_objs_start:0,m_vars_start:0,m_stat_start:0,m_abbr_start:0,m_hext_start:0,m_alpha_start:0,m_zalphabet:[],m_string_start:0,m_routine_start:0,m_unicode_start:0,m_custom_unicode_charcount:0,m_separator_count:0,m_separators:[],m_version:0,m_call_stack:[],m_locals:[],m_locals_stack:0,m_param_counts:0,m_result_targets:[],m_rebound:0,m_rebound_args:[],m_output_to_console:0,m_streamthrees:[],m_output_to_script:0,m_single_step:0,m_debug_mode:0,m_parser_debugging:0,m_value_asserts:0,m_breakpoints:{},m_console_buffer:"",m_transcript_buffer:"",m_effects:[],m_answers:[],m_random_state:0,m_random_use_seed:0,m_random_use_sequence:0,m_random_sequence_max:0,m_printing_header_bits:0,m_leftovers:"",m_pc_translate_for_routine:pc_translate_v45,m_pc_translate_for_string:pc_translate_v45,m_undo:[],m_state_to_save:0,m_quetzal_image:0,m_original_memory:[],m_object_tree_start:0,m_property_list_addr_start:0,m_object_size:14,m_interrupt_information:[],op_parchment_data:{}};var ZVMUI=Class.subClass({init:function(t,e){this.e=t,this.buffer="",extend(this,this.formatters[t.env.formatter]||{}),this.mono=e,this.process_colours(),this.currentwin=0,this.status=[],t.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",bg:this.bg})},erase_line:function(t){1===t&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(t){this.flush(),1>t&&this.clear_window(),-1===t&&this.split_window(0),(-2===t||1===t)&&this.status.push({code:"clear"})},flush:function(){if(""!==this.buffer){var t={code:"stream",text:this.buffer,props:this.format()};(this.currentwin?this.status:this.e.orders).push(t),this.buffer=""}},format:function(){var t,e={},r=[],n=this.fg,s=this.bg;return this.bold&&r.push("zvm-bold"),this.italic&&r.push("zvm-italic"),this.mono&&r.push("zvm-mono"),this.reverse&&(t=n,n=s||this.env.bg,s=t||this.env.fg),n!==void 0&&(isNaN(n)?e.css={color:n}:r.push("zvm-fg-"+n)),s!==void 0&&(isNaN(s)?(e.css||(e.css={}),e.css["background-color"]=s):r.push("zvm-bg-"+s)),r.length&&(e["class"]=r.join(" ")),e},get_cursor:function(t){this.status.push({code:"get_cursor",addr:t}),this.e.act()},process_colours:function(){function t(t){var e,r=Math.round,n=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(t);return n[1]?e=[n[1],n[2],n[3]]:(e=[parseInt(n[4],16),parseInt(n[5],16),parseInt(n[6],16)],4===t.length&&(e=[e[0]<<4|e[0],e[1]<<4|e[1],e[2]<<4|e[2]])),r(e[2]/8.226)<<10|r(e[1]/8.226)<<5|r(e[0]/8.226)}var e=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],r=this.e.env.fgcolour,n=this.e.env.bgcolour,s=r?t(r):65535,i=n?t(n):65535,_=e.indexOf(s),a=e.indexOf(i);2>_&&(_=r||2),2>a&&(a=n||9),this.env={fg:_,bg:a,fg_true:s,bg_true:i}},set_colour:function(t,e){this.flush(),1===t&&(this.fg=void 0),t>1&&13>t&&(this.fg=t),1===e&&(this.bg=void 0),e>1&&13>e&&(this.bg=e)},set_cursor:function(t,e){this.flush(),this.status.push({code:"cursor",to:[t-1,e-1]})},set_font:function(t){if(1!==t&&4!==t)return 0;var e=4&this.mono?4:1;return t!==e&&(this.flush(),this.mono^=4),e},set_style:function(t){this.flush(),0===t&&(this.reverse=this.bold=this.italic=0,this.mono&=254),1&t&&(this.reverse=1),2&t&&(this.bold=1),4&t&&(this.italic=1),8&t&&(this.mono|=1)},set_true_colour:function(t,e){function r(t){var e=Math.round(8.226*(31&t))<<16|Math.round(8.226*((992&t)>>5))<<8|Math.round(8.226*((31744&t)>>10));for(e=e.toString(16);6>e.length;)e="0"+e;return"#"+e}this.flush(),65535===t?this.fg=void 0:32768>t&&(this.fg=r(t)),65535===e?this.bg=void 0:32768>e&&(this.bg=r(e))},set_window:function(t){this.flush(),this.currentwin=t,this.e.orders.push({code:"find",name:t?"status":"main"}),t&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(t){this.flush(),this.status.push({code:"height",lines:t})},update_header:function(){var t=this.e.m;t.setUint8(44,isNaN(this.env.bg)?1:this.env.bg),t.setUint8(45,isNaN(this.env.fg)?1:this.env.fg),this.e.extension_table(5,this.env.fg_true),this.e.extension_table(6,this.env.bg_true)},formatters:{}}),GnustoRunner=Object.subClass({init:function(t,e){var r=this;e=window.engine=this.e=new GnustoEngine(window.console&&function(){console.log(msg)}||function(){}),this.io=new StructIO(t),this.env=this.io.env,this.io.TextInput.callback=function(t){r.inputEvent(t)}},fromParchment:function(t){var e,r=t.code,n=this.e;"load"==r&&n.loadStory(t.data),"restart"==r&&(this.restart(),e=1),"save"==r&&(n.answer(0,t.result||1),e=1),"restore"==r&&(this.ui||this.restart(),t.data?n.loadSavedGame(t.data):n.answer(0,0),e=1),e&&this.run()},restart:function(){var t=this.e,e=this.io;t.setByte(255,32),t.setByte(e.env.width,33),t.setWord(e.env.width,34),t.setWord(255,36),e.target=e.container.empty(),this.orders=[],this.ui=new ZVMUI(this,2&t.getByte(17)),e.event(this.orders),this.orders=[]},run:function(){var t,e,r,n,s,i,_=this.e,a=this.ui;for(this.orders=[];!s;)if(_.run(),t=_.consoleText(),t&&(a.buffer+=t),e='"'+_.effect(0)+'"',r=_.effect(1),n=_.effect(2),e==GNUSTO_EFFECT_INPUT&&(s=1,a.flush(),this.orders.push({code:"read",target:this.currentwin})),e==GNUSTO_EFFECT_INPUT_CHAR&&(s=1,this.orders.push({code:"char"})),e==GNUSTO_EFFECT_SAVE&&(s=1,_.saveGame(),this.toParchment({code:"save",data:_.saveGameData()})),e==GNUSTO_EFFECT_RESTORE&&(s=1,this.toParchment({code:"restore"})),e==GNUSTO_EFFECT_QUIT&&(s=1),e==GNUSTO_EFFECT_RESTART&&(_.resetStory(),this.restart(),a=this.ui),e==GNUSTO_EFFECT_FLAGS_CHANGED&&(a.flush(),a.mono=253&a.mono|2&_.m_printing_header_bits),e==GNUSTO_EFFECT_STYLE&&(0>r?a.set_colour(n,_.effect(3)):a.set_style(r)),e==GNUSTO_EFFECT_SPLITWINDOW&&a.split_window(r),e==GNUSTO_EFFECT_SETWINDOW&&a.set_window(r),e==GNUSTO_EFFECT_ERASEWINDOW&&a.erase_window(r),e==GNUSTO_EFFECT_ERASELINE&&a.erase_line(r),e==GNUSTO_EFFECT_SETCURSOR&&a.set_cursor(r,n),e==GNUSTO_EFFECT_GETCURSOR&&(s=1,a.get_cursor(r)),e==GNUSTO_EFFECT_PRINTTABLE)for(i=0;r>i;i++)a.buffer+="\n"+_.effect(2+i);a.flush(),a.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),a.status=[]),this.io.event(this.orders)},inputEvent:function(t){var e=this.e,r=t.code;"read"==r&&(this.ui.buffer+=t.response+"\n",e.answer(0,t.terminator),e.answer(1,t.response)),"char"==r&&e.answer(0,t.response),"get_cursor"==r&&(e.setWord(t.addr,t.pos[0]),e.setWord(t.addr+2,t.pos[1])),this.run()},act:function(){}});